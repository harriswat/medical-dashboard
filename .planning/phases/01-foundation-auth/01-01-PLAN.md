---
phase: 01-foundation-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - next.config.ts
  - tailwind.config.ts
  - components.json
  - middleware.ts
  - .env.local
  - src/app/layout.tsx
  - src/app/page.tsx
  - src/app/globals.css
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/lib/utils.ts
  - src/types/database.types.ts
autonomous: false
user_setup:
  - service: supabase
    why: "Auth and database backend (existing project)"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard (project ishhmpxejnzpoxuwaajn) -> Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard (project ishhmpxejnzpoxuwaajn) -> Settings -> API -> anon/public key"
    dashboard_config:
      - task: "Verify Email Auth provider is enabled"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email"
      - task: "Add Site URL for magic link redirects"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Site URL = http://localhost:3000"
      - task: "Add redirect URL for auth callback"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Redirect URLs -> add http://localhost:3000/auth/callback"
must_haves:
  truths:
    - "Next.js 15 app starts with `npm run dev` and renders at localhost:3000"
    - "Supabase browser and server clients are configured and importable"
    - "Middleware refreshes session on every request and protects dashboard routes"
    - "Unauthenticated users are redirected from /today and /history to /login"
    - "TypeScript compiles with no errors"
  artifacts:
    - path: "src/lib/supabase/client.ts"
      provides: "Browser-side Supabase client"
      exports: ["createClient"]
    - path: "src/lib/supabase/server.ts"
      provides: "Server-side Supabase client with cookie handling"
      exports: ["createClient"]
    - path: "middleware.ts"
      provides: "Session refresh on every request"
      contains: "supabase.auth"
    - path: "src/types/database.types.ts"
      provides: "TypeScript types for Supabase schema"
      contains: "Database"
  key_links:
    - from: "middleware.ts"
      to: "Supabase Auth"
      via: "session refresh on every request"
      pattern: "supabase\\.auth"
    - from: "src/lib/supabase/server.ts"
      to: "@supabase/ssr"
      via: "createServerClient with async cookies"
      pattern: "createServerClient"
---

<objective>
Scaffold the Next.js 15 project from scratch, install dependencies (Supabase SSR, shadcn/ui), configure Supabase browser and server clients, set up middleware for session refresh and route protection, and provide Supabase credentials via user setup.

Purpose: This is the bare foundation everything else builds on. No scaffolding = no app. The Supabase clients and middleware established here are used by every subsequent plan.

Output: A running Next.js 15 app with Supabase clients configured, middleware protecting routes, and real Supabase credentials in .env.local.
</objective>

<execution_context>
@/Users/harriswatkins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/harriswatkins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js 15 project and configure Supabase clients</name>
  <files>
    package.json
    tsconfig.json
    next.config.ts
    tailwind.config.ts
    components.json
    .env.local
    middleware.ts
    src/app/layout.tsx
    src/app/page.tsx
    src/app/globals.css
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
    src/lib/utils.ts
    src/types/database.types.ts
  </files>
  <action>
    1. Create Next.js 15 app in the project root (the cwd IS the project root -- scaffold here, not in a subdirectory):
       ```bash
       npx create-next-app@latest . --typescript --tailwind --app --src-dir --no-git --yes
       ```
       Use `--no-git` since git is already initialized. Use `.` to scaffold in current directory.

    2. Install dependencies:
       ```bash
       npm install @supabase/supabase-js @supabase/ssr zod
       ```

    3. Initialize shadcn/ui:
       ```bash
       npx shadcn@latest init --defaults
       ```
       Then add button and input components:
       ```bash
       npx shadcn@latest add button input label card
       ```

    4. Create `.env.local` with placeholder values (user will fill in real values from Supabase dashboard):
       ```
       NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
       NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
       ```

    5. Create browser Supabase client at `src/lib/supabase/client.ts`:
       - Use `createBrowserClient` from `@supabase/ssr`
       - Read from `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY`
       - Export a `createClient()` function

    6. Create server Supabase client at `src/lib/supabase/server.ts`:
       - Use `createServerClient` from `@supabase/ssr`
       - CRITICAL: Use `await cookies()` (Next.js 15 async cookies!)
       - Implement `getAll()` and `setAll()` cookie methods
       - Export an async `createClient()` function

    7. Create `middleware.ts` at project root (NOT inside src/):
       - Use `createServerClient` from `@supabase/ssr`
       - Refresh session on every request via `supabase.auth.getUser()`
       - Use matcher to exclude static files: `/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)`
       - Redirect unauthenticated users from dashboard routes to /login
       - Redirect authenticated users from /login to /today

    8. Create initial TypeScript types at `src/types/database.types.ts`:
       - Define a `Database` type with `public.Tables` containing a `profiles` table
       - Profile fields: id (uuid, FK to auth.users.id), email (text), display_name (text), role ('patient' | 'caregiver'), created_at (timestamptz), updated_at (timestamptz)
       - Export Row, Insert, Update types for profiles
       - This is a hand-written starter type; will be regenerated from Supabase schema later

    9. Update `src/app/layout.tsx`:
       - Set metadata: title "Medical Dashboard", description "Post-surgery care coordination"
       - Set viewport: width=device-width, initial-scale=1, viewport-fit=cover (for safe areas on iPhone)

    10. Update `src/app/page.tsx` to redirect to `/today` (simple server redirect).
  </action>
  <verify>
    Run `npm run dev` and confirm the app starts at localhost:3000 without errors.
    Run `npx tsc --noEmit` and confirm no TypeScript errors.
    Verify these files exist: middleware.ts, src/lib/supabase/client.ts, src/lib/supabase/server.ts, src/types/database.types.ts
  </verify>
  <done>
    Next.js 15 app runs at localhost:3000. Supabase browser and server clients are configured. Middleware handles session refresh and route protection. TypeScript compiles cleanly.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure Supabase credentials</name>
  <what-built>The app is scaffolded with placeholder Supabase credentials in .env.local</what-built>
  <action>
    The user needs to provide real Supabase credentials. Claude cannot access the Supabase dashboard.

    Instructions for the user:
    1. Go to https://supabase.com/dashboard/project/ishhmpxejnzpoxuwaajn/settings/api
    2. Copy the **Project URL** and paste it as `NEXT_PUBLIC_SUPABASE_URL` in `.env.local`
    3. Copy the **anon/public** key and paste it as `NEXT_PUBLIC_SUPABASE_ANON_KEY` in `.env.local`
    4. Go to Authentication -> Providers -> Email: ensure "Enable Email provider" is ON and "Enable email confirmations" is ON (for magic links)
    5. Go to Authentication -> URL Configuration:
       - Set **Site URL** to `http://localhost:3000`
       - Add `http://localhost:3000/auth/callback` to **Redirect URLs**
  </action>
  <how-to-verify>
    After updating .env.local, restart `npm run dev`. The app should load without Supabase connection errors in the terminal.
  </how-to-verify>
  <verify>After updating .env.local with real Supabase credentials and restarting `npm run dev`, the app loads without Supabase connection errors in the terminal.</verify>
  <done>Real Supabase credentials are in .env.local, email auth provider is enabled in Supabase dashboard, and redirect URLs are configured.</done>
  <resume-signal>Type "credentials configured" when .env.local has real values and Supabase dashboard is configured</resume-signal>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. `npx tsc --noEmit` passes
3. Supabase browser client importable from src/lib/supabase/client.ts
4. Supabase server client importable from src/lib/supabase/server.ts
5. Middleware exists at project root and contains session refresh logic
6. .env.local has real Supabase credentials (after checkpoint)
</verification>

<success_criteria>
- Next.js 15 app runs at localhost:3000
- Supabase SSR clients (browser + server) are configured correctly
- Middleware refreshes session and protects dashboard routes
- Real Supabase credentials are configured in .env.local
- TypeScript compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-01-SUMMARY.md`
</output>
