---
phase: 01-foundation-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - next.config.ts
  - tailwind.config.ts
  - components.json
  - middleware.ts
  - .env.local
  - src/app/layout.tsx
  - src/app/page.tsx
  - src/app/globals.css
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/auth/callback/route.ts
  - src/app/(dashboard)/layout.tsx
  - src/app/(dashboard)/today/page.tsx
  - src/app/(dashboard)/history/page.tsx
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/lib/utils.ts
  - src/types/database.types.ts
autonomous: false
user_setup:
  - service: supabase
    why: "Auth and database backend (existing project)"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard (project ishhmpxejnzpoxuwaajn) -> Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard (project ishhmpxejnzpoxuwaajn) -> Settings -> API -> anon/public key"
    dashboard_config:
      - task: "Verify Email Auth provider is enabled"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email"
      - task: "Add Site URL for magic link redirects"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Site URL = http://localhost:3000"
      - task: "Add redirect URL for auth callback"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Redirect URLs -> add http://localhost:3000/auth/callback"
must_haves:
  truths:
    - "Next.js 15 app starts with `npm run dev` and renders at localhost:3000"
    - "Harris can enter harriswatk@gmail.com and receive a magic link email"
    - "Kent can enter kentwatkins1@me.com and receive a magic link email"
    - "After clicking magic link, user is redirected to /today and session is active"
    - "Session persists across browser close and reopen (no re-login needed)"
    - "Unauthenticated users are redirected from /today and /history to /login"
    - "Supabase profiles table exists with RLS policies enabled"
  artifacts:
    - path: "src/lib/supabase/client.ts"
      provides: "Browser-side Supabase client"
      exports: ["createClient"]
    - path: "src/lib/supabase/server.ts"
      provides: "Server-side Supabase client with cookie handling"
      exports: ["createClient"]
    - path: "middleware.ts"
      provides: "Session refresh on every request"
      contains: "supabase.auth"
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Magic link login form"
      contains: "signInWithOtp"
    - path: "src/app/(auth)/auth/callback/route.ts"
      provides: "Auth callback for magic link redirect"
      contains: "exchangeCodeForSession"
    - path: "src/app/(dashboard)/layout.tsx"
      provides: "Authenticated dashboard layout shell"
      contains: "redirect"
  key_links:
    - from: "src/app/(auth)/login/page.tsx"
      to: "Supabase Auth API"
      via: "signInWithOtp call"
      pattern: "signInWithOtp"
    - from: "src/app/(auth)/auth/callback/route.ts"
      to: "src/lib/supabase/server.ts"
      via: "exchangeCodeForSession"
      pattern: "exchangeCodeForSession"
    - from: "middleware.ts"
      to: "Supabase Auth"
      via: "session refresh on every request"
      pattern: "supabase\\.auth"
    - from: "src/app/(dashboard)/layout.tsx"
      to: "/login"
      via: "redirect when unauthenticated"
      pattern: "redirect.*login"
---

<objective>
Scaffold the Next.js 15 project from scratch, configure Supabase SSR auth with magic link login, create the database schema with RLS, and wire up the complete authentication flow so Harris and Kent can log in once and stay logged in forever.

Purpose: This is the foundation everything else builds on. No auth = no app. The persistent-session magic link flow means neither user has to deal with passwords or re-login during a stressful recovery period.

Output: A running Next.js 15 app with working magic link auth, protected routes, and Supabase schema ready for real-time data.
</objective>

<execution_context>
@/Users/harriswatkins/.claude/get-shit-done/workflows/execute-plan.md
@/Users/harriswatkins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js 15 project and configure Supabase clients</name>
  <files>
    package.json
    tsconfig.json
    next.config.ts
    tailwind.config.ts
    components.json
    .env.local
    middleware.ts
    src/app/layout.tsx
    src/app/page.tsx
    src/app/globals.css
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
    src/lib/utils.ts
    src/types/database.types.ts
  </files>
  <action>
    1. Create Next.js 15 app in the project root (the cwd IS the project root -- scaffold here, not in a subdirectory):
       ```bash
       npx create-next-app@latest . --typescript --tailwind --app --src-dir --no-git --yes
       ```
       Use `--no-git` since git is already initialized. Use `.` to scaffold in current directory.

    2. Install dependencies:
       ```bash
       npm install @supabase/supabase-js @supabase/ssr zod
       ```

    3. Initialize shadcn/ui:
       ```bash
       npx shadcn@latest init --defaults
       ```
       Then add button and input components:
       ```bash
       npx shadcn@latest add button input label card
       ```

    4. Create `.env.local` with placeholder values (user will fill in real values from Supabase dashboard):
       ```
       NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
       NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
       ```

    5. Create browser Supabase client at `src/lib/supabase/client.ts`:
       - Use `createBrowserClient` from `@supabase/ssr`
       - Read from `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY`
       - Export a `createClient()` function

    6. Create server Supabase client at `src/lib/supabase/server.ts`:
       - Use `createServerClient` from `@supabase/ssr`
       - CRITICAL: Use `await cookies()` (Next.js 15 async cookies!)
       - Implement `getAll()` and `setAll()` cookie methods
       - Export an async `createClient()` function

    7. Create `middleware.ts` at project root (NOT inside src/):
       - Use `createServerClient` from `@supabase/ssr`
       - Refresh session on every request via `supabase.auth.getUser()`
       - Use matcher to exclude static files: `/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)`
       - Redirect unauthenticated users from dashboard routes to /login
       - Redirect authenticated users from /login to /today

    8. Create initial TypeScript types at `src/types/database.types.ts`:
       - Define a `Database` type with `public.Tables` containing a `profiles` table
       - Profile fields: id (uuid, FK to auth.users.id), email (text), display_name (text), role ('patient' | 'caregiver'), created_at (timestamptz), updated_at (timestamptz)
       - Export Row, Insert, Update types for profiles
       - This is a hand-written starter type; will be regenerated from Supabase schema later

    9. Update `src/app/layout.tsx`:
       - Set metadata: title "Medical Dashboard", description "Post-surgery care coordination"
       - Set viewport: width=device-width, initial-scale=1, viewport-fit=cover (for safe areas on iPhone)

    10. Update `src/app/page.tsx` to redirect to `/today` (simple server redirect).
  </action>
  <verify>
    Run `npm run dev` and confirm the app starts at localhost:3000 without errors.
    Run `npx tsc --noEmit` and confirm no TypeScript errors.
    Verify these files exist: middleware.ts, src/lib/supabase/client.ts, src/lib/supabase/server.ts, src/types/database.types.ts
  </verify>
  <done>
    Next.js 15 app runs at localhost:3000. Supabase browser and server clients are configured. Middleware handles session refresh and route protection. TypeScript compiles cleanly.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure Supabase credentials</name>
  <what-built>The app is scaffolded with placeholder Supabase credentials in .env.local</what-built>
  <action>
    The user needs to provide real Supabase credentials. Claude cannot access the Supabase dashboard.

    Instructions for the user:
    1. Go to https://supabase.com/dashboard/project/ishhmpxejnzpoxuwaajn/settings/api
    2. Copy the **Project URL** and paste it as `NEXT_PUBLIC_SUPABASE_URL` in `.env.local`
    3. Copy the **anon/public** key and paste it as `NEXT_PUBLIC_SUPABASE_ANON_KEY` in `.env.local`
    4. Go to Authentication -> Providers -> Email: ensure "Enable Email provider" is ON and "Enable email confirmations" is ON (for magic links)
    5. Go to Authentication -> URL Configuration:
       - Set **Site URL** to `http://localhost:3000`
       - Add `http://localhost:3000/auth/callback` to **Redirect URLs**
  </action>
  <how-to-verify>
    After updating .env.local, restart `npm run dev`. The app should load without Supabase connection errors in the terminal.
  </how-to-verify>
  <resume-signal>Type "credentials configured" when .env.local has real values and Supabase dashboard is configured</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Auth flow -- magic link login, callback, and protected routes</name>
  <files>
    src/app/(auth)/login/page.tsx
    src/app/(auth)/auth/callback/route.ts
    src/app/(dashboard)/layout.tsx
    src/app/(dashboard)/today/page.tsx
    src/app/(dashboard)/history/page.tsx
  </files>
  <action>
    1. Create login page at `src/app/(auth)/login/page.tsx`:
       - Client component ('use client')
       - Simple form: email input + "Send Magic Link" button using shadcn Button and Input
       - On submit: call `supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.origin + '/auth/callback' } })`
       - Show "Check your email for the magic link!" after successful send
       - Show error message if email send fails
       - Validate email client-side: only allow harriswatk@gmail.com and kentwatkins1@me.com (show friendly message for other emails: "This app is for Harris and Kent only")
       - Style: centered card layout, warm and inviting, use soft greens. Think Headspace login -- minimal, calming.

    2. Create auth callback route at `src/app/(auth)/auth/callback/route.ts`:
       - GET handler that extracts `code` from URL search params
       - Exchange code for session using `supabase.auth.exchangeCodeForSession(code)`
       - On success: redirect to `/today`
       - On error: redirect to `/login?error=auth`

    3. Create dashboard layout at `src/app/(dashboard)/layout.tsx`:
       - Server component
       - Check auth: `const supabase = await createClient(); const { data: { user } } = await supabase.auth.getUser()`
       - If no user, `redirect('/login')`
       - Render children (the actual page content) -- no nav yet, that comes in Plan 02
       - Pass user info to children if needed via React context or props

    4. Create placeholder Today page at `src/app/(dashboard)/today/page.tsx`:
       - Server component
       - Get user from Supabase server client
       - Show: "Welcome, [user email]" and "Today's schedule will appear here"
       - This is a placeholder -- Plan 02 adds the real shell

    5. Create placeholder History page at `src/app/(dashboard)/history/page.tsx`:
       - Server component
       - Show: "History will appear here"

    6. Create Supabase schema by running SQL via the Supabase Management API or by providing migration SQL the user can run. Since we have the anon key (not service role), provide the SQL as a migration file at `supabase/migrations/001_initial_schema.sql`:

       ```sql
       -- Create profiles table (extends auth.users)
       CREATE TABLE IF NOT EXISTS public.profiles (
         id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
         email TEXT NOT NULL,
         display_name TEXT NOT NULL,
         role TEXT NOT NULL CHECK (role IN ('patient', 'caregiver')),
         created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
         updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
       );

       -- Enable RLS
       ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

       -- Both Harris and Kent can see all profiles (they're a care team)
       CREATE POLICY "Care team can view all profiles"
         ON public.profiles FOR SELECT
         USING (auth.uid() IS NOT NULL);

       -- Users can update their own profile
       CREATE POLICY "Users can update own profile"
         ON public.profiles FOR UPDATE
         USING (auth.uid() = id)
         WITH CHECK (auth.uid() = id);

       -- Users can insert their own profile (on first login)
       CREATE POLICY "Users can insert own profile"
         ON public.profiles FOR INSERT
         WITH CHECK (auth.uid() = id);

       -- Index for RLS performance
       CREATE INDEX IF NOT EXISTS idx_profiles_id ON public.profiles(id);

       -- Auto-create profile on signup via trigger
       CREATE OR REPLACE FUNCTION public.handle_new_user()
       RETURNS TRIGGER AS $$
       BEGIN
         INSERT INTO public.profiles (id, email, display_name, role)
         VALUES (
           NEW.id,
           NEW.email,
           CASE
             WHEN NEW.email = 'harriswatk@gmail.com' THEN 'Harris'
             WHEN NEW.email = 'kentwatkins1@me.com' THEN 'Kent'
             ELSE split_part(NEW.email, '@', 1)
           END,
           CASE
             WHEN NEW.email = 'harriswatk@gmail.com' THEN 'patient'
             WHEN NEW.email = 'kentwatkins1@me.com' THEN 'caregiver'
             ELSE 'patient'
           END
         );
         RETURN NEW;
       END;
       $$ LANGUAGE plpgsql SECURITY DEFINER;

       -- Trigger to auto-create profile
       DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
       CREATE TRIGGER on_auth_user_created
         AFTER INSERT ON auth.users
         FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

       -- Updated_at auto-update trigger
       CREATE OR REPLACE FUNCTION public.handle_updated_at()
       RETURNS TRIGGER AS $$
       BEGIN
         NEW.updated_at = NOW();
         RETURN NEW;
       END;
       $$ LANGUAGE plpgsql;

       CREATE TRIGGER profiles_updated_at
         BEFORE UPDATE ON public.profiles
         FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

       -- Enable Realtime for profiles table
       ALTER PUBLICATION supabase_realtime ADD TABLE public.profiles;
       ```

       Also create a `supabase/migrations/002_sync_log.sql` for the sync infrastructure table:

       ```sql
       -- Sync log for tracking changes (used by real-time sync in Plan 02)
       CREATE TABLE IF NOT EXISTS public.sync_log (
         id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
         table_name TEXT NOT NULL,
         record_id UUID NOT NULL,
         action TEXT NOT NULL CHECK (action IN ('INSERT', 'UPDATE', 'DELETE')),
         changed_by UUID REFERENCES auth.users(id),
         changed_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
         payload JSONB
       );

       ALTER TABLE public.sync_log ENABLE ROW LEVEL SECURITY;

       -- Both users can see all sync logs (shared care team)
       CREATE POLICY "Care team can view sync logs"
         ON public.sync_log FOR SELECT
         USING (auth.uid() IS NOT NULL);

       -- Authenticated users can insert sync logs
       CREATE POLICY "Authenticated users can insert sync logs"
         ON public.sync_log FOR INSERT
         WITH CHECK (auth.uid() IS NOT NULL);

       CREATE INDEX idx_sync_log_table ON public.sync_log(table_name);
       CREATE INDEX idx_sync_log_changed_at ON public.sync_log(changed_at);

       -- Enable Realtime
       ALTER PUBLICATION supabase_realtime ADD TABLE public.sync_log;
       ```

       Print clear instructions for the user to run these migrations in the Supabase SQL Editor.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes with no errors
    2. Navigate to localhost:3000 -- should redirect to /login
    3. Enter harriswatk@gmail.com -- should show "Check your email" message (actual email delivery depends on Supabase config)
    4. Enter a random email -- should show "This app is for Harris and Kent only"
    5. Navigate to localhost:3000/today directly -- should redirect to /login (unauthenticated)
    6. Verify migration SQL files exist at supabase/migrations/
  </verify>
  <done>
    Login page renders with magic link form. Only Harris and Kent emails are accepted. Auth callback route exchanges code for session. Dashboard routes are protected (redirect to login). Schema migrations are ready to run. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. `npx tsc --noEmit` passes
3. Unauthenticated visit to / redirects to /login
4. Login page accepts only harriswatk@gmail.com and kentwatkins1@me.com
5. After magic link authentication, user lands on /today with their email displayed
6. Closing browser and reopening maintains the session (no re-login)
7. Migration SQL files exist and are ready for Supabase SQL Editor
</verification>

<success_criteria>
- Next.js 15 app runs at localhost:3000
- Supabase SSR clients (browser + server) are configured correctly
- Middleware refreshes session and protects dashboard routes
- Magic link login works for Harris and Kent only
- Session persists across browser restarts
- Database schema (profiles + sync_log) is defined with RLS policies
- TypeScript compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-01-SUMMARY.md`
</output>
